#!/usr/bin/env bash
# Using my configured file system aliases, all filesystem shortcuts
# alongside the absolute directory they connect to in PATH like form.

print_usage() {
  echo "Usage: $0 [-h]"
}

print_help() {
  print_usage
  echo ""
  echo "Using my configured aliases, filter out all filesystem"
  echo "shortcuts and present them to the user with file paths"
  echo "properly expanded."
  echo ""
  echo "Options:"
  echo "  -h    show this help message and exit"
  echo "  -r    replace '$HOME' with ~/ before outputting"
  echo "  -e    only show dirmaps that currently exist."
  echo "        prints non-existant paths to stderr."
}

while getopts 'hre' option; do
  case "$option" in
    h) print_help
       exit 0 ;;
    \?) print_help >&2
        exit 1 ;;
    r) home_relative=1 ;;
    e) exists_only=1 ;;
  esac
done

. build-aliases
read_script $(ls-aliases) |
  sed 's/ \+/:/' |
  while IFS=':' read -r key path; do
    case "$key" in
      # only working with dirx for now
      *@dirx*) key="${key%@dirx*}" ;;
      *) continue ;;
    esac

    path=$(eval echo "$path")
    [ -z "$path" ] && continue

    if [ "${exists_only:-0}" -eq 0 ] || [ -e "$path" ]; then
      echo "$key:$path"
    fi
  done |
  if [ "${home_relative:-0}" -eq 1 ] && [ -n "$HOME" ]; then
    awk -v home="$HOME" '{
      pos = index($0, sprintf(":%s", home))
      if (pos == 0) {
        print $0
      } else {
        printf("%s~/%s\n", substr($0, 1, pos), substr($0, pos+length(home)+2, length($0)))
      }
    }'
  else
    cat
  fi
